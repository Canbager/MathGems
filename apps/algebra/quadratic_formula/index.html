<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadratic Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/roughjs@latest/bundled/rough.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Gochi+Hand&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sketch-font { font-family: 'Gochi Hand', cursive; }
        canvas { display: block; touch-action: none; background: #fff; }
        .rough-area { filter: url(#rough-paper); }
        
        .sketch-input {
            border: 2px solid #334155;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-family: 'Gochi Hand', cursive;
            font-size: 1.25rem;
            text-align: center;
            outline: none;
            transition: all 0.2s;
            background-color: #fff;
        }
        .sketch-input:focus {
            border-color: #4f46e5;
            box-shadow: 2px 2px 0px 0px #4f46e5;
        }
        .sketch-btn {
            background-color: #fff;
            border: 2px solid #1e293b;
            font-family: 'Gochi Hand', cursive;
            font-weight: bold;
            box-shadow: 2px 2px 0px 0px #1e293b;
            transition: all 0.1s;
            cursor: pointer;
        }
        .sketch-btn:active {
            box-shadow: none;
            transform: translate(2px, 2px);
        }
        .step-box {
            transition: all 0.3s ease-in-out;
        }
        .animate-pop {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Custom Checkbox */
        .sketch-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #1e293b;
            border-radius: 0.25em;
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        .sketch-checkbox::before {
            content: "";
            width: 0.85em;
            height: 0.85em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #4f46e5;
            background-color: #4f46e5;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .sketch-checkbox:checked::before {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <svg style="position: absolute; width: 0; height: 0;">
        <filter id="rough-paper">
            <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="1.5" />
        </filter>
    </svg>

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- HEADER -->
        <div class="bg-white border-4 border-slate-800 p-6 rounded-xl shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold sketch-font text-slate-800">Quadratic Quest</h1>
                <p class="text-slate-600 text-sm font-semibold">Discriminant &rarr; Decision &rarr; Solution</p>
            </div>
            
            <div class="flex flex-wrap gap-4 items-center bg-slate-100 p-3 rounded-lg border-2 border-slate-800">
                <label class="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" id="opt-factor" class="sketch-checkbox" checked>
                    <span class="font-bold text-slate-700 text-sm">Perfect Squares</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" id="opt-surd" class="sketch-checkbox">
                    <span class="font-bold text-slate-700 text-sm">Surds (Hard Mode)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" id="opt-complex" class="sketch-checkbox">
                    <span class="font-bold text-slate-700 text-sm">No Real Roots</span>
                </label>
                <button id="resetBtn" class="bg-white border-2 border-slate-800 px-4 py-1 rounded sketch-font font-bold hover:bg-yellow-50 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all">
                    New Question
                </button>
            </div>
        </div>

        <div class="grid md:grid-cols-12 gap-6">
            <!-- LEFT COLUMN: Problem & Guided Solver -->
            <div class="md:col-span-7 flex flex-col gap-6">
                
                <div class="bg-white border-4 border-slate-800 rounded-xl overflow-hidden shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] flex-1">
                    <div class="p-6 md:p-8 rough-area relative">
                        <!-- Decorative tape -->
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-32 h-8 bg-yellow-100/50 rotate-[-2deg] border border-yellow-200"></div>

                        <div id="problem-text" class="text-slate-800 leading-relaxed text-2xl sketch-font flex justify-center py-6 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 mb-6">
                            Loading...
                        </div>

                        <!-- GUIDED SOLVER STEPS -->
                        <div class="space-y-6">
                            
                            <!-- STEP 1: DISCRIMINANT -->
                            <div id="box-step1" class="step-box bg-white border-4 border-indigo-200 p-4 rounded-lg relative">
                                <div class="absolute -top-3 left-4 bg-indigo-100 px-2 border border-indigo-300 rounded text-sm font-bold text-indigo-800 sketch-font">Step 1: The Discriminant</div>
                                
                                <div class="mt-2 space-y-3">
                                    <p class="sketch-font text-slate-600">Calculate the discriminant: $ \Delta = b^2 - 4ac $</p>
                                    <div class="flex flex-wrap items-center gap-2 justify-center bg-indigo-50 p-3 rounded border border-indigo-100">
                                        <div class="flex items-center gap-1">
                                            <span class="text-sm font-bold text-slate-500">a=</span>
                                            <span id="disp-a" class="font-bold text-lg">?</span>
                                        </div>, 
                                        <div class="flex items-center gap-1">
                                            <span class="text-sm font-bold text-slate-500">b=</span>
                                            <span id="disp-b" class="font-bold text-lg">?</span>
                                        </div>, 
                                        <div class="flex items-center gap-1">
                                            <span class="text-sm font-bold text-slate-500">c=</span>
                                            <span id="disp-c" class="font-bold text-lg">?</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-center gap-2">
                                        <span class="sketch-font text-xl font-bold">$\Delta =$</span>
                                        <input type="number" id="input-discriminant" class="sketch-input w-24">
                                        <button onclick="checkDiscriminant()" class="sketch-btn px-4 py-2 hover:bg-indigo-50 rounded">Check</button>
                                        <span id="feedback-step1" class="text-lg"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- STEP 2: DECISION -->
                            <div id="box-step2" class="step-box opacity-50 pointer-events-none bg-slate-50 border-2 border-dashed border-slate-300 p-4 rounded-lg relative">
                                <div class="absolute -top-3 left-4 bg-slate-200 px-2 border border-slate-300 rounded text-sm font-bold text-slate-500 sketch-font">Step 2: The Decision</div>
                                
                                <div class="mt-2 space-y-3 text-center">
                                    <p class="sketch-font text-slate-700">Based on $\Delta =$ <span id='val-delta-display'>...</span>, which method should we use?</p>
                                    <div class="flex flex-wrap justify-center gap-4">
                                        <button onclick="chooseStrategy('factor')" class="sketch-btn px-4 py-3 bg-white hover:bg-green-50 rounded text-green-800 border-green-800 flex flex-col items-center gap-1 min-w-[120px]">
                                            <span class="text-lg">Factorise</span>
                                            <span class="text-[10px] uppercase font-sans font-bold bg-green-200 px-1 rounded">Perfect Square</span>
                                        </button>
                                        <button onclick="chooseStrategy('formula')" class="sketch-btn px-4 py-3 bg-white hover:bg-blue-50 rounded text-blue-800 border-blue-800 flex flex-col items-center gap-1 min-w-[120px]">
                                            <span class="text-lg">Formula</span>
                                            <span class="text-[10px] uppercase font-sans font-bold bg-blue-200 px-1 rounded">Not Square</span>
                                        </button>
                                        <button onclick="chooseStrategy('none')" class="sketch-btn px-4 py-3 bg-white hover:bg-red-50 rounded text-red-800 border-red-800 flex flex-col items-center gap-1 min-w-[120px]">
                                            <span class="text-lg">Stop</span>
                                            <span class="text-[10px] uppercase font-sans font-bold bg-red-200 px-1 rounded">No Real Roots</span>
                                        </button>
                                    </div>
                                    <div id="feedback-step2" class="text-lg font-bold sketch-font min-h-[1.5em]"></div>
                                </div>
                            </div>

                            <!-- STEP 3: SOLVE (DYNAMIC CONTENT) -->
                            <div id="box-step3" class="step-box opacity-50 pointer-events-none bg-slate-50 border-2 border-dashed border-slate-300 p-4 rounded-lg relative">
                                <div class="absolute -top-3 left-4 bg-slate-200 px-2 border border-slate-300 rounded text-sm font-bold text-slate-500 sketch-font">Step 3: Solve</div>
                                
                                <!-- Mode: Factorise -->
                                <div id="mode-factorise" class="hidden mt-2 space-y-4 text-center">
                                    <p class="sketch-font text-slate-600">Create the factorised version:</p>
                                    <div class="flex items-center justify-center gap-1 text-xl sketch-font flex-wrap">
                                        <span>(</span>
                                        <input type="number" id="input-fac-a1" class="sketch-input w-12 p-1" placeholder="p">
                                        <span>x + </span>
                                        <input type="number" id="input-fac-c1" class="sketch-input w-12 p-1" placeholder="q">
                                        <span>)(</span>
                                        <input type="number" id="input-fac-a2" class="sketch-input w-12 p-1" placeholder="r">
                                        <span>x + </span>
                                        <input type="number" id="input-fac-c2" class="sketch-input w-12 p-1" placeholder="s">
                                        <span>) = 0</span>
                                    </div>
                                    <p class="text-xs text-slate-400">Enter coefficients (e.g. for $x-3$, enter $1x + -3$)</p>
                                    <button onclick="checkFactors()" class="sketch-btn px-6 py-2 bg-indigo-50 hover:bg-indigo-100 rounded">Check Factors</button>
                                    <div id="feedback-factors" class="text-lg"></div>
                                </div>

                                <!-- Mode: Formula -->
                                <div id="mode-formula" class="hidden mt-2 space-y-4 text-center">
                                    <p class="sketch-font text-slate-600">Using: $ x = \frac{-b \pm \sqrt{\Delta}}{2a} $</p>
                                    <div id="formula-display" class="bg-blue-50 p-4 rounded border border-blue-200 inline-block text-left text-lg">
                                        <!-- Will be filled by JS -->
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-sm text-slate-500">Enter final values (2 decimal places):</p>
                                        <div class="flex justify-center gap-4">
                                            <div class="flex items-center gap-1">
                                                $x_1 =$ <input type="number" id="input-root-1" step="0.01" class="sketch-input w-24">
                                            </div>
                                            <div class="flex items-center gap-1">
                                                $x_2 =$ <input type="number" id="input-root-2" step="0.01" class="sketch-input w-24">
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="checkRoots()" class="sketch-btn px-6 py-2 bg-indigo-50 hover:bg-indigo-100 rounded">Check Answers</button>
                                    <div id="feedback-roots" class="text-lg"></div>
                                </div>

                                <!-- Mode: None -->
                                <div id="mode-none" class="hidden mt-2 text-center">
                                    <div class="p-4 bg-red-50 text-red-800 rounded border border-red-200 sketch-font text-xl">
                                        Discriminant is negative. <br>The parabola never touches the x-axis!
                                    </div>
                                </div>
                                
                                <!-- Success Banner -->
                                <div id="success-banner" class="hidden mt-6 bg-yellow-100 border-4 border-yellow-400 p-4 rounded-lg shadow-[4px_4px_0px_0px_rgba(234,179,8,1)] animate-pop text-center">
                                    <h3 class="text-2xl font-bold sketch-font text-yellow-800">ðŸŽ‰ Quadratic Conquered! ðŸŽ‰</h3>
                                    <div class="mt-2 bg-white border-2 border-yellow-800 p-2 rounded inline-block">
                                        <span class="text-indigo-600 font-bold">ðŸ‘‰ Check the graph to visualize the roots!</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- SDG BOX -->
                <div class="bg-emerald-50 border-4 border-slate-800 rounded-xl p-4 flex items-center gap-4 shadow-[4px_4px_0px_0px_rgba(30,41,59,1)]">
                    <div class="shrink-0 w-14 h-14 bg-emerald-600 rounded flex items-center justify-center text-white font-bold text-2xl shadow-sm">4</div>
                    <div>
                        <h3 class="font-bold text-emerald-900 text-sm uppercase">Quality Education</h3>
                        <p class="text-xs text-emerald-800 leading-tight">Understanding the discriminant helps visualize the nature of roots in polynomial functions.</p>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Visualisation -->
            <div class="md:col-span-5 space-y-6">
                <!-- GRAPH CANVAS -->
                <div class="bg-white border-4 border-slate-800 rounded-xl overflow-hidden relative shadow-[8px_8px_0px_0px_rgba(30,41,59,1)]">
                    <div class="absolute top-2 left-2 z-10 bg-white/90 px-2 py-1 border border-slate-800 rounded text-xs font-bold sketch-font">
                        Parabola Graph
                    </div>
                    <div id="canvas-wrapper" class="w-full aspect-square bg-white cursor-crosshair relative">
                        <canvas id="geoCanvas"></canvas>
                    </div>
                    <div class="p-3 border-t-4 border-slate-800 bg-slate-50 text-center">
                        <div class="flex justify-center gap-6 text-sm font-bold sketch-font">
                            <div class="flex items-center gap-2">
                                <span class="block w-4 h-4 bg-blue-500 rounded-full border border-black"></span> $y = ax^2+bx+c$
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="block w-3 h-3 bg-red-500 rounded-full border border-black"></span> Roots
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tip Box -->
                <div id="tip-box" class="bg-amber-50 border-4 border-slate-800 rounded-xl p-6 shadow-[4px_4px_0px_0px_rgba(30,41,59,1)] relative overflow-hidden transition-all">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-amber-200 rounded-full opacity-50"></div>
                    <h4 class="font-bold text-amber-900 sketch-font text-lg mb-2">Teacher's Tip:</h4>
                    <p id="tip-text" class="text-sm text-amber-800 italic">
                        "If $ \Delta $ is a perfect square (0, 1, 4, 9, 16...), you can factorise. If not, use the formula!"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const canvas = document.getElementById('geoCanvas');
        const ctx = canvas.getContext('2d');
        const roughCanvas = rough.canvas(canvas);
        
        let currentProblem = null;
        let scale = 20; 
        let origin = { x: 0, y: 0 };
        let showCurve = true; 
        let showRoots = false;

        // --- UTILITIES ---
        const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const isSquare = (n) => n >= 0 && Math.sqrt(n) % 1 === 0;

        // --- PROBLEM GENERATION ---
        function generateProblem() {
            const optFactor = document.getElementById('opt-factor').checked;
            const optSurd = document.getElementById('opt-surd').checked;
            const optComplex = document.getElementById('opt-complex').checked;

            let allowedTypes = [];
            if (optFactor) allowedTypes.push('factor');
            if (optSurd) allowedTypes.push('surd');
            if (optComplex) allowedTypes.push('complex');

            if (allowedTypes.length === 0) {
                allowedTypes.push('factor');
                document.getElementById('opt-factor').checked = true;
            }

            const type = allowedTypes[Math.floor(Math.random() * allowedTypes.length)];
            
            let a, b, c, delta;
            let attempt = 0;
            
            do {
                attempt++;
                
                if (type === 'factor') {
                    // Type A: Factorable (Integer Roots)
                    let r1 = rnd(-6, 6);
                    let r2 = rnd(-6, 6);
                    let scales = [1, 1, 1, 1, 2, 3, -1]; 
                    a = scales[Math.floor(Math.random() * scales.length)];
                    b = -a * (r1 + r2);
                    c = a * (r1 * r2);
                } else if (type === 'surd') {
                    // Type B: Surds
                    a = rnd(1, 4);
                    if(Math.random() > 0.5) a *= -1;
                    b = rnd(-10, 10);
                    c = rnd(-10, 10);
                } else {
                    // Type C: No Real Roots
                    a = rnd(1, 4);
                    if(Math.random() > 0.5) a *= -1;
                    b = rnd(-8, 8);
                    c = rnd(5, 12) * (a > 0 ? 1 : -1); 
                }
                
                delta = b*b - 4*a*c;
                
                if (a === 0) continue;
                if (type === 'factor' && !isSquare(delta)) continue;
                if (type === 'surd' && (delta < 0 || isSquare(delta))) continue;
                if (type === 'complex' && delta >= 0) continue;
                
                break; 
            } while(attempt < 200);

            if (attempt >= 200) { a=1; b=2; c=1; delta=0; }

            currentProblem = { a, b, c, delta };
            showRoots = false;
            
            let eqStr = "";
            if(Math.abs(a) === 1) eqStr += (a < 0 ? "-" : "") + "x^2";
            else eqStr += a + "x^2";
            if(b !== 0) {
                if(b > 0) eqStr += " + "; else eqStr += " - ";
                if(Math.abs(b) !== 1) eqStr += Math.abs(b) + "x"; else eqStr += "x";
            }
            if(c !== 0) {
                if(c > 0) eqStr += " + " + c; else eqStr += " - " + Math.abs(c);
            }
            eqStr += " = 0";

            katex.render(eqStr, document.getElementById('problem-text'), { throwOnError: false, displayMode: true });
            
            document.getElementById('disp-a').textContent = a;
            document.getElementById('disp-b').textContent = b;
            document.getElementById('disp-c').textContent = c;

            resetUI();
            resizeCanvas(); 
            
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- UI LOGIC ---
        function resetUI() {
            document.querySelectorAll('input').forEach(i => {
                if(i.type === 'number') i.value = '';
            });
            document.querySelectorAll('[id^=feedback]').forEach(d => d.innerHTML = '');
            
            resetBox('box-step1', true);
            resetBox('box-step2', false);
            resetBox('box-step3', false);
            
            document.getElementById('mode-factorise').classList.add('hidden');
            document.getElementById('mode-formula').classList.add('hidden');
            document.getElementById('mode-none').classList.add('hidden');
            document.getElementById('success-banner').classList.add('hidden');
            
            document.getElementById('tip-text').innerText = "Start by identifying a, b, and c to find the discriminant.";
        }

        function resetBox(id, active) {
            const el = document.getElementById(id);
            if (active) {
                el.classList.remove('opacity-50', 'pointer-events-none', 'bg-slate-50', 'border-dashed', 'border-slate-300');
                el.classList.add('bg-white', 'border-4', 'border-indigo-200');
            } else {
                el.classList.add('opacity-50', 'pointer-events-none', 'bg-slate-50', 'border-dashed', 'border-slate-300');
                el.classList.remove('bg-white', 'border-4', 'border-indigo-200');
            }
        }

        function feedback(id, isCorrect, msg="") {
            const el = document.getElementById(id);
            if(isCorrect) el.innerHTML = `<span class="text-emerald-600 font-bold">âœ“</span>`;
            else el.innerHTML = `<span class="text-red-500 font-bold">âœ— ${msg}</span>`;
        }

        // --- STEP 1: DISCRIMINANT ---
        function checkDiscriminant() {
            const userD = parseFloat(document.getElementById('input-discriminant').value);
            // Allow integer comparison safely for typical IGCSE ranges
            if (Math.abs(userD - currentProblem.delta) < 0.001) {
                feedback('feedback-step1', true);
                resetBox('box-step2', true);
                document.getElementById('val-delta-display').textContent = userD;
                // Safe re-render attempt for the step 2 container
                try { renderMathInElement(document.getElementById('box-step2')); } catch(e){}
                
                document.getElementById('tip-text').innerText = "Now decide! Is the discriminant a perfect square (0, 1, 4, 9...)?";
            } else {
                feedback('feedback-step1', false, "Check bÂ² - 4ac");
            }
        }

        // --- STEP 2: DECISION ---
        function chooseStrategy(choice) {
            const D = currentProblem.delta;
            let correctChoice = '';
            
            if (D < 0) correctChoice = 'none';
            else if (isSquare(D)) correctChoice = 'factor';
            else correctChoice = 'formula';

            const fb = document.getElementById('feedback-step2');
            
            if (choice === correctChoice) {
                fb.innerHTML = `<span class="text-emerald-600">Good Choice!</span>`;
                setupStep3(choice);
            } else {
                if (D < 0 && choice !== 'none') fb.innerHTML = `<span class="text-red-600">Look at D. It's negative!</span>`;
                else if (choice === 'factor' && !isSquare(D)) fb.innerHTML = `<span class="text-red-600">${D} is not a perfect square.</span>`;
                else if (choice === 'formula' && isSquare(D)) fb.innerHTML = `<span class="text-amber-600">You *could*, but Factorising is faster!</span>`;
                else if (choice === 'none' && D >= 0) fb.innerHTML = `<span class="text-red-600">D is positive/zero. There are roots!</span>`;
            }
        }

        function setupStep3(mode) {
            resetBox('box-step3', true);
            document.getElementById('mode-factorise').classList.add('hidden');
            document.getElementById('mode-formula').classList.add('hidden');
            document.getElementById('mode-none').classList.add('hidden');

            if (mode === 'none') {
                document.getElementById('mode-none').classList.remove('hidden');
                document.getElementById('success-banner').classList.remove('hidden');
                showRoots = true; 
                resizeCanvas();
            } else if (mode === 'factor') {
                document.getElementById('mode-factorise').classList.remove('hidden');
                document.getElementById('tip-text').innerText = "Determine the coefficients that multiply to make the original equation.";
                try { renderMathInElement(document.getElementById('mode-factorise')); } catch(e){}
            } else {
                document.getElementById('mode-formula').classList.remove('hidden');
                document.getElementById('tip-text').innerText = "Substitute values carefully. Calculate the square root term first.";
                
                const p = currentProblem;
                const formulaHTML = `$$ x = \\frac{-(${p.b}) \\pm \\sqrt{${p.delta}}}{2(${p.a})} $$`;
                document.getElementById('formula-display').innerHTML = formulaHTML;
                try { renderMathInElement(document.getElementById('mode-formula')); } catch(e){}
            }
        }

        // --- STEP 3: SOLVE ---
        function checkFactors() {
            const a1 = parseFloat(document.getElementById('input-fac-a1').value);
            const c1 = parseFloat(document.getElementById('input-fac-c1').value);
            const a2 = parseFloat(document.getElementById('input-fac-a2').value);
            const c2 = parseFloat(document.getElementById('input-fac-c2').value);
            
            if (isNaN(a1) || isNaN(c1) || isNaN(a2) || isNaN(c2)) { 
                feedback('feedback-factors', false, "Enter all values"); 
                return; 
            }

            // Expand: (a1*a2)x^2 + (a1*c2 + a2*c1)x + (c1*c2)
            const calcA = a1 * a2;
            const calcB = a1 * c2 + a2 * c1;
            const calcC = c1 * c2;
            
            const targetA = currentProblem.a;
            const targetB = currentProblem.b;
            const targetC = currentProblem.c;
            
            const matchExact = (Math.abs(calcA - targetA) < 0.01 && Math.abs(calcB - targetB) < 0.01 && Math.abs(calcC - targetC) < 0.01);
            
            if (matchExact) {
                feedback('feedback-factors', true, "Correct Factors!");
                document.getElementById('success-banner').classList.remove('hidden');
                showRoots = true; 
                resizeCanvas();
            } else {
                let msg = `Expands to: ${calcA}xÂ² ${calcB>=0?'+':''} ${calcB}x ${calcC>=0?'+':''} ${calcC}`;
                feedback('feedback-factors', false, msg);
            }
        }

        function checkRoots() {
            const u1 = parseFloat(document.getElementById('input-root-1').value);
            const u2 = parseFloat(document.getElementById('input-root-2').value);
            
            if(isNaN(u1) && isNaN(u2)) { feedback('feedback-roots', false, "Enter roots"); return; }

            const r1 = (-currentProblem.b + Math.sqrt(currentProblem.delta)) / (2*currentProblem.a);
            const r2 = (-currentProblem.b - Math.sqrt(currentProblem.delta)) / (2*currentProblem.a);
            
            let match1 = false;
            let match2 = false;

            // Handle repeated roots case (Delta = 0)
            if (Math.abs(currentProblem.delta) < 0.001) {
                // If user enters the single root in either box, we count it
                const val = !isNaN(u1) ? u1 : u2;
                if (Math.abs(val - r1) < 0.05) match1 = true;
                match2 = true; // Effectively ignore the second matching requirement
            } else {
                if(isNaN(u1) || isNaN(u2)) { feedback('feedback-roots', false, "Enter both roots"); return; }
                match1 = (Math.abs(u1 - r1) < 0.05 && Math.abs(u2 - r2) < 0.05);
                match2 = (Math.abs(u1 - r2) < 0.05 && Math.abs(u2 - r1) < 0.05);
            }
            
            if (match1 || match2) {
                feedback('feedback-roots', true, "Correct!");
                document.getElementById('success-banner').classList.remove('hidden');
                showRoots = true;
                resizeCanvas();
            } else {
                feedback('feedback-roots', false, "Check your formula calculation");
            }
        }

        // --- VISUALISATION ---
        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            drawGraph();
        }

        function drawGraph() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(!currentProblem) return;

            const w = canvas.width;
            const h = canvas.height;
            const originX = w / 2;
            const originY = h / 2;
            
            const vx = -currentProblem.b / (2 * currentProblem.a);
            const vy = currentProblem.c - (currentProblem.b * currentProblem.b) / (4 * currentProblem.a);
            
            const dist = Math.sqrt(Math.abs(currentProblem.delta)) / (2 * Math.abs(currentProblem.a));
            const maxX = Math.max(Math.abs(vx + dist), Math.abs(vx - dist), 5);
            const maxY = Math.max(Math.abs(vy), 10);
            
            scale = Math.min(w/(2.5*maxX), h/(2.5*maxY));
            if(scale < 5) scale = 5; 

            const toScreen = (x, y) => ({
                x: originX + x * scale,
                y: originY - y * scale
            });

            // Grid
            ctx.beginPath();
            ctx.strokeStyle = "#f1f5f9";
            ctx.lineWidth = 1;
            const rangeX = Math.ceil(w/2/scale);
            const rangeY = Math.ceil(h/2/scale);
            
            for(let i = -rangeX; i <= rangeX; i++) {
                let p1 = toScreen(i, 0); ctx.moveTo(p1.x, 0); ctx.lineTo(p1.x, h);
            }
            for(let i = -rangeY; i <= rangeY; i++) {
                let p1 = toScreen(0, i); ctx.moveTo(0, p1.y); ctx.lineTo(w, p1.y);
            }
            ctx.stroke();

            // Axes
            roughCanvas.line(0, originY, w, originY, { stroke: '#94a3b8', strokeWidth: 2 });
            roughCanvas.line(originX, 0, originX, h, { stroke: '#94a3b8', strokeWidth: 2 });

            // Plot Function
            const step = 0.1;
            const points = [];
            for(let x = -rangeX; x <= rangeX; x += step) {
                const y = currentProblem.a * x * x + currentProblem.b * x + currentProblem.c;
                const p = toScreen(x, y);
                points.push([p.x, p.y]);
            }
            roughCanvas.curve(points, { stroke: '#3b82f6', strokeWidth: 3 });

            // Roots
            if (showRoots && currentProblem.delta >= 0) {
                const r1 = (-currentProblem.b + Math.sqrt(currentProblem.delta)) / (2*currentProblem.a);
                const r2 = (-currentProblem.b - Math.sqrt(currentProblem.delta)) / (2*currentProblem.a);
                
                const p1 = toScreen(r1, 0);
                const p2 = toScreen(r2, 0);
                
                roughCanvas.circle(p1.x, p1.y, 8, { fill: '#ef4444', fillStyle: 'solid', stroke: 'none' });
                roughCanvas.circle(p2.x, p2.y, 8, { fill: '#ef4444', fillStyle: 'solid', stroke: 'none' });
                
                ctx.fillStyle = "#ef4444";
                ctx.font = "bold 14px sans-serif";
                ctx.fillText(r1.toFixed(2), p1.x - 10, p1.y - 10);
                if (Math.abs(r1 - r2) > 0.5) { 
                    ctx.fillText(r2.toFixed(2), p2.x - 10, p2.y - 10);
                }
            }
        }

        // --- INIT ---
        window.addEventListener('resize', resizeCanvas);
        document.getElementById('resetBtn').addEventListener('click', generateProblem);
        
        generateProblem();

        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });

    </script>
</body>
</html>
